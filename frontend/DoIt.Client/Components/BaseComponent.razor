@using DoIt.Client.Components.Loading;
@using DoIt.Client.Models.Loading;
@using DoIt.Client.Services.Toast

@code {
    [Inject] public ToastService ToastService { get; set; }

    protected LoadingState LoadingState = LoadingState.Loading;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAndStateAsync();
        await base.OnInitializedAsync();
    }

    protected virtual Task LoadDataAsync()
    {
        return Task.CompletedTask;
    }

    private async Task LoadDataAndStateAsync()
    {
        try
        {
            await OnDataLoadingAsync();
            await LoadDataAsync();
            await OnDataLoadedAsync();
        }
        catch (Exception ex)
        {
            ToastService.ShowError(ex.Message);

            await OnDataLoadedFailedAsync();
        }
    }

    private Task OnDataLoadingAsync()
    {
        LoadingState = LoadingState.Loading;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private Task OnDataLoadedAsync()
    {
        LoadingState = LoadingState.Rendered;

        return Task.CompletedTask;
    }

    private Task OnDataLoadedFailedAsync()
    {
        LoadingState = LoadingState.Error;

        return Task.CompletedTask;
    }
}
